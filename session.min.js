/**
 * session.js 0.4.1
 * (c) 2012 Iain, CodeJoust
 * session.js is freely distributable under the MIT license.
 * Portions of session.js are inspired or borrowed from Underscore.js, and quirksmode.org demo javascript.
 * This version uses google's jsapi library for location services.
 * For details, see: https://github.com/codejoust/session.js
 */
var session_fetch=function(a,b,c){"use strict";var d=.4,e={use_html5_location:!1,ipinfodb_key:!1,gapi_location:!0,location_cookie:"location",location_cookie_timeout:5,session_timeout:32,session_cookie:"first_session"},f=function(){if(a.session=a.session||{},a.session.contains=function(a){if("string"==typeof a)return-1!==this.indexOf(a);for(var b=0;b<a.length;b++)if(-1!==this.indexOf(a[b]))return!0;return!1},a.session&&a.session.options)for(var b in a.session.options)e[b]=a.session.options[b];var c={api_version:d,locale:h.locale(),current_session:h.session(),original_session:h.session(e.session_cookie,1e3*60*60*24*e.session_timeout),browser:h.browser(),plugins:h.plugins(),time:h.time(),device:h.device()};if(e.use_html5_location?c.location=h.html5_location():e.ipinfodb_key?c.location=h.ipinfodb_location(e.ipinfodb_key):e.gapi_location&&(c.location=h.gapi_location()),a.session&&a.session.start)var f=a.session.start;var i,g=0,k=function(b){b&&g--,0===g&&f&&f(a.session)};a.session={};for(var l in c)if(i=c[l],"function"==typeof i)try{i(function(b){a.session[l]=b,k(!0)}),g++}catch(m){a.console&&"function"==typeof console.log&&(console.log(m),k(!0))}else a.session[l]=i;k()},g={detect:function(){return{browser:this.search(this.data.browser),version:this.search(c.userAgent)||this.search(c.appVersion),os:this.search(this.data.os),oscpu:this.search(this.data.oscpu),platform:this.search(this.data.platform)}},search:function(a){if("object"!=typeof a){var e=a.indexOf(this.version_string);if(-1==e)return;return parseFloat(a.substr(e+this.version_string.length+1))}for(var b=0;b<a.length;b++){var c=a[b].string,d=a[b].prop;if(this.version_string=a[b].versionSearch||a[b].identity,c){if(-1!=c.indexOf(a[b].subString))return a[b].identity}else if(d)return a[b].identity}},data:{browser:[{string:c.userAgent,subString:"Chrome",identity:"Chrome"},{string:c.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:c.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:a.opera,identity:"Opera",versionSearch:"Version"},{string:c.vendor,subString:"iCab",identity:"iCab"},{string:c.vendor,subString:"KDE",identity:"Konqueror"},{string:c.userAgent,subString:"Firefox",identity:"Firefox"},{string:c.vendor,subString:"Camino",identity:"Camino"},{string:c.userAgent,subString:"Netscape",identity:"Netscape"},{string:c.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:c.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:c.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],os:[{string:c.platform,subString:"Win",identity:"Windows"},{string:c.platform,subString:"Mac",identity:"Mac"},{string:c.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:c.userAgent,subString:"iPad",identity:"iPad"},{string:c.userAgent,subString:"Android",identity:"Android"},{string:c.platform,subString:"Linux",identity:"Linux"}],oscpu:[{string:c.userAgent,subString:"Win16",identity:"3.11"},{string:c.userAgent,subString:"Windows 95",identity:"95"},{string:c.userAgent,subString:"Win95",identity:"95"},{string:c.userAgent,subString:"Windows_95",identity:"95"},{string:c.userAgent,subString:"Windows 98",identity:"98"},{string:c.userAgent,subString:"Win98",identity:"98"},{string:c.userAgent,subString:"Windows NT 5.0",identity:"2000"},{string:c.userAgent,subString:"Windows 2000",identity:"2000"},{string:c.userAgent,subString:"Windows NT 5.1",identity:"XP"},{string:c.userAgent,subString:"Windows XP",identity:"XP"},{string:c.userAgent,subString:"Windows NT 5.2",identity:"Server 2003"},{string:c.userAgent,subString:"Windows NT 6.0",identity:"Vista"},{string:c.userAgent,subString:"Windows NT 6.1",identity:"7"},{string:c.userAgent,subString:"Windows NT 4.0",identity:"NT 4.0"},{string:c.userAgent,subString:"Windows ME",identity:"ME"},{string:c.userAgent,subString:"",identity:"sconosciuto"}],platform:[{string:c.userAgent,subString:"WOW64",identity:"64 bit"},{string:c.userAgent,subString:"Win64",identity:"64 bit"},{string:c.userAgent,subString:"MacIntel",identity:"64 bit"},{string:c.userAgent,subString:"",identity:"32 bit"}]}},h={browser:function(){return g.detect()},time:function(){var a=new Date,b=new Date;return a.setMonth(0),a.setDate(1),b.setMonth(6),b.setDate(1),{tz_offset:-(new Date).getTimezoneOffset()/60,observes_dst:a.getTimezoneOffset()!==b.getTimezoneOffset()}},locale:function(){var a=(c.language||c.browserLanguage||c.systemLanguage||c.userLanguage||"").split("-");return 2==a.length?{country:a[1].toLowerCase(),lang:a[0].toLowerCase()}:a?{lang:a[0].toLowerCase(),country:null}:{lang:null,country:null}},device:function(){var d={screen:{width:a.screen.width,height:a.screen.height}};return d.viewport={width:a.innerWidth||b.documentElement.clientWidth||b.body.clientWidth,height:a.innerHeight||b.documentElement.clientHeight||b.body.clientHeight},d.is_tablet=!!c.userAgent.match(/(iPad|SCH-I800|xoom|kindle)/i),d.is_phone=!d.is_tablet&&!!c.userAgent.match(/(iPhone|iPod|blackberry|android 0.5|htc|lg|midp|mmp|mobile|nokia|opera mini|palm|pocket|psp|sgh|smartphone|symbian|treo mini|Playstation Portable|SonyEricsson|Samsung|MobileExplorer|PalmSource|Benq|Windows Phone|Windows Mobile|IEMobile|Windows CE|Nintendo Wii)/i),d.is_mobile=d.is_tablet||d.is_phone,d},plugins:function(){var a=function(a){if(c.plugins&&c.plugins.length>0){for(var b,d=0,e=c.plugins.length;e>d;d++)if(b=c.plugins[d],b&&b.name&&-1!==b.name.toLowerCase().indexOf(a))return!0;return!1}if("flash"==a){var f=null;try{f=new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(g){return!1}if(null!=f){var h;try{h=f.GetVariable("$version")}catch(i){return!1}return!0}}return!1};return{flash:a("flash"),silverlight:a("silverlight"),java:a("java"),quicktime:a("quicktime")}},session:function(c,d){var e=i.get_obj(c);if(null==e){e={visits:1,start:(new Date).getTime(),last_visit:(new Date).getTime(),url:a.location.href,path:a.location.pathname,referrer:b.referrer,referrer_info:i.parse_url(b.referrer),search:{engine:null,query:null}};var h,f=[{name:"Google",host:"google",query:"q"},{name:"Bing",host:"bing.com",query:"q"},{name:"Yahoo",host:"search.yahoo",query:"p"},{name:"AOL",host:"search.aol",query:"q"},{name:"Ask",host:"ask.com",query:"q"},{name:"Baidu",host:"baidu.com",query:"wd"}],g=f.length,k=0,l="q query term p wd query text".split(" ");for(k=0;g>k;k++)if(h=f[k],-1!==e.referrer_info.host.indexOf(h.host)){e.search.engine=h.name,e.search.query=e.referrer_info.query[h.query],e.search.terms=e.search.query?e.search.query.split(" "):null;break}if(null===e.search.engine&&e.referrer_info.search.length>1)for(k=0;k<l.length;k++){var m=e.referrer_info.query[l[k]];if(m){e.search.engine="Unknown",e.search.query=m,e.search.terms=m.split(" ");break}}}else e.prev_visit=e.last_visit,e.last_visit=(new Date).getTime(),e.visits++,e.time_since_last_visit=e.last_visit-e.prev_visit;return i.set_cookie(c,i.package_obj(e),d),e},html5_location:function(){return function(a){c.geolocation.getCurrentPosition(function(b){b.source="html5",a(b),i.set_cookie(e.location_cookie,i.package_obj(b),1e3*60*60*e.location_cookie_timeout)},function(){e.gapi_location?h.gapi_location()(a):a({error:!0,source:"html5"})})}},gapi_location:function(){return function(b){var c=i.get_obj(e.location_cookie);c&&"google"===c.source?b(c):(a.gloader_ready=function(){"google"in a&&(a.google.loader.ClientLocation?(a.google.loader.ClientLocation.source="google",b(a.google.loader.ClientLocation)):b({error:!0,source:"google"}),i.set_cookie(e.location_cookie,i.package_obj(a.google.loader.ClientLocation),1e3*60*60*e.location_cookie_timeout))},i.embed_script("https://www.google.com/jsapi?callback=gloader_ready"))}},ipinfodb_location:function(b){return function(c){var d=i.get_obj(e.location_cookie);d&&"ipinfodb"===d.source&&c(d),a.ipinfocb=function(a){if("OK"===a.statusCode)a.source="ipinfodb",i.set_cookie(e.location_cookie,i.package_obj(a),1e3*60*60*e.location_cookie),c(a);else{if(e.gapi_location)return h.gapi_location()(c);c({error:!0,source:"ipinfodb",message:a.statusMessage})}},i.embed_script("http://api.ipinfodb.com/v3/ip-city/?key="+b+"&format=json&callback=ipinfocb")}}},i={parse_url:function(a){var c=b.createElement("a"),d={};c.href=a;var e=c.search.substr(1);if(""!=e)for(var i,f=e.split("&"),g=0,h=f.length;h>g;g++)i=f[g].split("="),2===i.length&&(d[i[0]]=decodeURI(i[1]));return{host:c.host,path:c.pathname,protocol:c.protocol,port:""===c.port?80:c.port,search:c.search,query:d}},set_cookie:function(c,d,e,f){return c?(f||(f={}),(null===d||void 0===d)&&(e=-1),e&&(f.expires=(new Date).getTime()+e),b.cookie=[encodeURIComponent(c),"=",encodeURIComponent(String(d)),f.expires?"; expires="+new Date(f.expires).toUTCString():"","; path="+(f.path?f.path:"/"),f.domain?"; domain="+f.domain:"",a.location&&"https:"===a.location.protocol?"; secure":""].join("")):null},get_cookie:function(a,c){return(c=new RegExp("(?:^|; )"+encodeURIComponent(a)+"=([^;]*)").exec(b.cookie))?decodeURIComponent(c[1]):null},embed_script:function(a){var c=b.createElement("script");c.type="text/javascript",c.src=a,b.getElementsByTagName("body")[0].appendChild(c)},package_obj:function(a){if(a){a.version=d;var b=j.stringify(a);return delete a.version,b}},get_obj:function(a){var b;try{b=j.parse(i.get_cookie(a))}catch(c){}return b&&b.version==d?(delete b.version,b):void 0}},j={parse:a.JSON&&a.JSON.parse||function(a){return"string"==typeof a&&a?new Function("return "+a)():null},stringify:a.JSON&&a.JSON.stringify||function(a){var b=typeof a;if("object"===b&&null!==a){var c,d,e=[],f=a&&a.constructor===Array;for(c in a)d=a[c],b=typeof d,"string"===b?d='"'+d+'"':"object"===b&&null!==d&&(d=this.stringify(d)),e.push((f?"":'"'+c+'":')+d);return(f?"[":"{")+e.join(",")+(f?"]":"}")}return"string"===b?'"'+a+'"':void 0}};f()};"undefined"==typeof window.exports?session_fetch(window,document,navigator):window.exports.session=session_fetch;